<div class="property-details-page" *ngIf="property">

  <!-- Breadcrumb -->
  <div class="breadcrumb-section">
    <div class="container">
      <nav class="breadcrumb">
        <a routerLink="/">{{ 'common.home' | translate }}</a>
        <i class="bi bi-chevron-left"></i>
        <a [routerLink]="property.purpose.toLowerCase() === 'rent' ? '/rent' : '/buy'">
          {{ property.purpose.toLowerCase() === 'rent' ? ('property.details.for_rent' | translate) : ('property.details.for_sale' | translate) }}
        </a>
        <i class="bi bi-chevron-left"></i>
        <span>{{ property.title }}</span>
      </nav>
    </div>
  </div>

  <div class="container">
    <div class="details-layout">

      <!-- Left Column - Images & Details -->
      <div class="details-main">

        <!-- Property Header -->
        <div class="property-header-section">
          <div class="header-content">
            <div class="title-section">
              <h1 class="property-main-title">{{ property.title }}</h1>
              <p class="property-location-main">
                <i class="bi bi-geo-alt-fill"></i>
                {{ property.area }}, {{ property.city }}
              </p>
            </div>
            <div class="header-actions">
              <button type="button" class="share-btn" (click)="shareProperty()" title="Share">
                <i class="bi bi-share"></i>
              </button>
              <button
                type="button"
                class="favorite-btn-large"
                [class.active]="property.isFavorite"
                (click)="toggleFavorite($event)"
                title="Add to Favorites">
                <i class="bi" [ngClass]="property.isFavorite ? 'bi-heart-fill' : 'bi-heart'"></i>
              </button>
            </div>
          </div>
          <div class="price-section">
            <span class="main-price">{{ property.price | currency:'EGP':'symbol':'1.0-0' }}</span>
            <span class="price-label">{{ getPriceLabel() }}</span>
          </div>
        </div>

        <!-- Image Gallery -->
        <div class="image-gallery-section">
          <div class="main-image">
            <img [src]="mainImageUrl" [alt]="property.title">
            <span class="purpose-badge-details" [class.rent]="property.purpose.toLowerCase() === 'rent'">
              {{ getPropertyPurposeLabel() }}
            </span>
          </div>

         <!-- الصور الإضافية من images -->
          <div class="row">
<div
  class="thumbnail"
  *ngFor="let img of property.images || []"
  [class.active]="mainImageUrl === img"
  (click)="changeMainImage(img)">
  <img [src]="img" alt="Additional Image">
</div>
        </div>
        </div>

        <!-- Property Details -->
        <div class="details-section">
          <h2 class="section-title">
            <i class="bi bi-info-circle"></i>
            {{ 'property.details.details_title' | translate }}
          </h2>

          <div class="details-grid">
            <div class="detail-card">
              <i class="bi bi-door-open-fill"></i>
              <div class="detail-info">
                <span class="detail-label">{{ 'property.details.bedrooms' | translate }}</span>
                <span class="detail-value">{{ property.rooms || 'N/A' }}</span>
              </div>
            </div>

            <div class="detail-card">
              <i class="bi bi-droplet-fill"></i>
              <div class="detail-info">
                <span class="detail-label">{{ 'property.details.bathrooms' | translate }}</span>
                <span class="detail-value">{{ property.bathrooms || 'N/A' }}</span>
              </div>
            </div>

            <div class="detail-card">
              <i class="bi bi-arrows-fullscreen"></i>
              <div class="detail-info">
                <span class="detail-label">{{ 'property.details.area' | translate }}</span>
                <span class="detail-value">{{ property.areaSpace || property.area || 'N/A' }} m²</span>
              </div>
            </div>

            <div class="detail-card">
              <i class="bi bi-house"></i>
              <div class="detail-info">
                <span class="detail-label">{{ 'property.details.type' | translate }}</span>
                <span class="detail-value">{{ ('property.' + (property.propertyType || 'apartment').toLowerCase()) | translate }}</span>
              </div>
            </div>

            <div class="detail-card">
              <i class="bi bi-paint-bucket"></i>
              <div class="detail-info">
                <span class="detail-label">{{ 'property.details.finishing' | translate }}</span>
                <span class="detail-value">{{ ('forms.add_property.' + (property.finishingLevel || 'standard').toLowerCase()) | translate }}</span>
              </div>
            </div>

            <div class="detail-card">
              <i class="bi bi-eye-fill"></i>
              <div class="detail-info">
                <span class="detail-label">{{ 'property.details.views' | translate }}</span>
                <span class="detail-value">{{ property.views || 0 }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Description -->
        <div class="description-section">
          <h2 class="section-title">
            <i class="bi bi-file-text"></i>
            {{ 'property.details.description' | translate }}
          </h2>
          <p class="description-text">
            {{ property.description || 'This stunning property offers modern living at its finest. With spacious rooms, contemporary finishes, and prime location, this home is perfect for families looking for comfort and convenience. The property features high-quality materials throughout, ample natural light, and easy access to local amenities.' }}
          </p>
        </div>

        <!-- Features & Amenities -->
        <!-- <div class="features-section">
          <h2 class="section-title">
            <i class="bi bi-check-circle"></i>
            Features & Amenities
          </h2>
          <div class="features-grid">
            <div class="feature-item">
              <i class="bi bi-check2"></i>
              <span>Air Conditioning</span>
            </div>
            <div class="feature-item">
              <i class="bi bi-check2"></i>
              <span>Swimming Pool</span>
            </div>
            <div class="feature-item">
              <i class="bi bi-check2"></i>
              <span>Garden</span>
            </div>
            <div class="feature-item">
              <i class="bi bi-check2"></i>
              <span>Security System</span>
            </div>
            <div class="feature-item">
              <i class="bi bi-check2"></i>
              <span>Balcony</span>
            </div>
            <div class="feature-item">
              <i class="bi bi-check2"></i>
              <span>Modern Kitchen</span>
            </div>
            <div class="feature-item">
              <i class="bi bi-check2"></i>
              <span>Storage Room</span>
            </div>
            <div class="feature-item">
              <i class="bi bi-check2"></i>
              <span>Elevator</span>
            </div>
          </div>
        </div> -->

        <!-- Rating Section -->
        <!-- <div class="rating-section">
          <h2 class="section-title">
            <i class="bi bi-star"></i>
            Rate This Property
          </h2>
          <div class="rating-container">
            <div class="rating-summary">
              <div class="rating-number">{{ averageRating | number:'1.1-1' }}</div>
              <div class="rating-stars-display">
                <i class="bi" [ngClass]="getStarClass(1)"></i>
                <i class="bi" [ngClass]="getStarClass(2)"></i>
                <i class="bi" [ngClass]="getStarClass(3)"></i>
                <i class="bi" [ngClass]="getStarClass(4)"></i>
                <i class="bi" [ngClass]="getStarClass(5)"></i>
              </div>
              <div class="rating-count">{{ totalRatings }} ratings</div>
            </div>

            <div class="rating-input">
              <p class="rating-label">{{ hasRated ? 'Thank you for rating!' : 'Rate this property:' }}</p>
              <div class="rating-stars">
                <i
                  *ngFor="let star of [1,2,3,4,5]"
                  class="bi rating-star"
                  [ngClass]="(hoverRating || userRating) >= star ? 'bi-star-fill active' : 'bi-star'"
                  (click)="setRating(star)"
                  (mouseenter)="setHoverRating(star)"
                  (mouseleave)="clearHoverRating()">
                </i>
              </div>
            </div>
          </div>
        </div> -->
        <!-- Add Rating -->
<!-- Add Rating -->
<div class="add-rating-section" *ngIf="isRentalProperty">
  <h2 class="section-title">
    <i class="bi bi-star"></i>
    {{ 'property.details.rate_property' | translate }}
  </h2>

  <div class="rating-stars">
    <i *ngFor="let star of [1,2,3,4,5]"
       class="bi"
       [ngClass]="star <= selectedRating ? 'bi-star-fill' : 'bi-star'"
       (click)="!userHasRated && (selectedRating = star)">
    </i>
  </div>

  <button
    class="submit-rating-btn"
    (click)="submitRating()"
    [disabled]="!selectedRating || isSubmittingRating || userHasRated">
    {{ userHasRated ? ('property.details.you_already_rated' | translate) : ('property.details.submit_rating' | translate) }}
  </button>

  <div class="average-rating" *ngIf="reviewStats">
    <span>{{ 'property.details.average_rating' | translate }}: {{ reviewStats.averageRating | number:'1.1-1' }} ⭐</span>
    <span>({{ reviewStats.reviewsCount }} {{ 'property.details.reviews' | translate }})</span>
  </div>
</div>



        <!-- Location Map -->
        <div class="location-section">
          <h2 class="section-title">
            <i class="bi bi-geo-alt"></i>
            {{ 'property.details.location' | translate }}
          </h2>
          <div class="map-container">
            <iframe
              src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d55251.37747992967!2d31.223915!3d30.0444196!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x14583fa60b21beeb%3A0x79dfb296e8423bba!2sCairo%2C%20Egypt!5e0!3m2!1sen!2s!4v1234567890"
              width="100%"
              height="400"
              style="border:0; border-radius: 12px;"
              allowfullscreen=""
              loading="lazy">
            </iframe>
          </div>
        </div>

        <!-- Similar Properties -->
        <div class="similar-properties-section" *ngIf="similarProperties.length > 0">
          <h2 class="section-title">
            <i class="bi bi-houses"></i>
            {{ 'property.details.similar_properties' | translate }}
          </h2>
          <div class="similar-grid">
            <div
              class="similar-card"
              *ngFor="let prop of similarProperties; trackBy: trackById"
              [routerLink]="['/property', prop.id]">
              <div class="similar-image">
                <img [src]="prop.imageUrl || galleryImages[0]" [alt]="prop.title">
                <span class="similar-badge" [class.rent]="prop.purpose.toLowerCase() === 'rent'">
                  {{ prop.purpose.toLowerCase() === 'rent' ? ('property.details.for_rent' | translate) : ('property.details.for_sale' | translate) }}
                </span>
              </div>
              <div class="similar-info">
                <h4>{{ prop.title }}</h4>
                <p class="similar-location">
                  <i class="bi bi-geo-alt"></i>
                  {{ prop.area }}, {{ prop.city }}
                </p>
                <div class="similar-details">
                  <span><i class="bi bi-door-open"></i> {{ prop.rooms }}</span>
                  <span><i class="bi bi-droplet"></i> {{ prop.bathrooms }}</span>
                  <span><i class="bi bi-arrows-fullscreen"></i> {{ prop.areaSpace || prop.area }}</span>
                </div>
                <div class="similar-price">
                  {{ prop.price | currency:'EGP':'symbol':'1.0-0' }}
                  {{ prop.purpose.toLowerCase() === 'rent' ? ('property.details.per_month' | translate) : '' }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Sidebar - Contact Card -->
      <aside class="contact-sidebar">
        <div class="contact-card sticky-card">
          <div class="agent-info">
            <!-- <img src="https://i.pravatar.cc/100?img=12" alt="Agent" class="agent-avatar"> -->
            <div class="agent-details">
              <!-- <h3>{{ property.ownerName || 'Salma Esam' }}</h3> -->
              <!-- <p> Sales</p> -->
                <h2 class="section-title">
    <i class="bi bi-star"></i>
    {{ 'property.details.rating' | translate }}
  </h2>
<div class="agent-rating" *ngIf="reviewStats && isRentalProperty">
  <ng-container *ngFor="let star of [1,2,3,4,5]; let i = index">
    <i
      class="bi"
      [ngClass]="{
        'bi-star-fill': reviewStats.averageRating > i,
        'bi-star-half': reviewStats.averageRating > i && reviewStats.averageRating < i + 1,
        'bi-star': reviewStats.averageRating <= i
      }">
    </i>
  </ng-container>
  <span>{{ reviewStats.averageRating }} ({{ reviewStats.reviewsCount }} {{ 'property.details.reviews' | translate }})</span>
</div>


            </div>
          </div>

          <div class="contact-actions">
           <button type="button" class="contact-btn primary" (click)="openCallModal()">
  <i class="bi bi-telephone-fill"></i>
  {{ 'common.call_now' | translate }}
</button>

<!-- Call Modal -->
<div class="call-modal" *ngIf="showCallModal">
  <div class="call-modal-content">
    <h4>{{ 'property.call_us' | translate }}</h4>
    <p>{{ defaultPhone }}</p>
    <button (click)="makeCall()">{{ 'common.call_now' | translate }}</button>
    <button (click)="closeCallModal()">{{ 'common.close' | translate }}</button>
  </div>
</div>

           <button
  type="button"
  class="contact-btn secondary"
  (click)="sendEmail()">
  <i class="bi bi-envelope-fill"></i>
  {{ 'property.details.send_email' | translate }}
</button>

            <button type="button" class="contact-btn whatsapp" (click)="openWhatsApp()">
              <i class="bi bi-whatsapp"></i>
              WhatsApp
            </button>
<button
  *ngIf="isRentalProperty"
  (click)="payNow(propertyId)"
  class="contact-btn payment">
  <i class="bi bi-credit-card-fill"></i>
  {{ 'common.cancel' | translate }}
</button>
          </div>

          <div class="schedule-visit">
            <h4>{{ 'property.details.schedule_visit' | translate }}</h4>
            <form class="visit-form" (ngSubmit)="submitVisitRequest()">
              <input
                type="text"
                placeholder="{{ 'forms.visit_form.name' | translate }}"
                class="form-input"
                [(ngModel)]="visitForm.name"
                name="name"
                required>
              <input
                type="email"
                placeholder="{{ 'property.details.your_email' | translate }}"
                class="form-input"
                [(ngModel)]="visitForm.email"
                name="email"
                required>
              <input
                type="tel"
                placeholder="{{ 'property.details.your_phone' | translate }}"
                class="form-input"
                [(ngModel)]="visitForm.phone"
                name="phone"
                required>
              <input
                type="date"
                placeholder="{{ 'property.details.preferred_date' | translate }}"
                class="form-input"
                [(ngModel)]="visitForm.date"
                name="date"
                required>
              <textarea
                placeholder="{{ 'property.details.message_optional' | translate }}"
                class="form-textarea"
                rows="3"
                [(ngModel)]="visitForm.message"
                name="message"></textarea>
              <button type="submit" class="submit-btn">
                <i class="bi bi-calendar-check"></i>
                {{ 'property.details.request_visit' | translate }}
              </button>
            </form>
          </div>
        </div>
      </aside>
    </div>
  </div>
</div>

<!-- Loading State -->
<div class="loading-state" *ngIf="!property">
  <div class="spinner"></div>
  <p>{{ 'property.details.loading' | translate }}</p>
</div>
